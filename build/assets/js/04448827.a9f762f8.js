"use strict";(self.webpackChunklux_docs=self.webpackChunklux_docs||[]).push([[876],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return h}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=c(n),h=i,m=p["".concat(l,".").concat(h)]||p[h]||u[h]||r;return n?a.createElement(m,o(o({ref:t},d),{},{components:n})):a.createElement(m,o({ref:t},d))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},9321:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return u}});var a=n(7462),i=n(3366),r=(n(7294),n(3905)),o=["components"],s={description:"This tutorial will help users to send transactions with dynamic fee settings to adjust their priority fee and max fee cap during high network activity using javascript."},l="Sending Transactions with Dynamic Fees using Javascript",c={unversionedId:"quickstart/sending-transactions-with-dynamic-fees-using-javascript",id:"quickstart/sending-transactions-with-dynamic-fees-using-javascript",title:"Sending Transactions with Dynamic Fees using Javascript",description:"This tutorial will help users to send transactions with dynamic fee settings to adjust their priority fee and max fee cap during high network activity using javascript.",source:"@site/docs/quickstart/sending-transactions-with-dynamic-fees-using-javascript.md",sourceDirName:"quickstart",slug:"/quickstart/sending-transactions-with-dynamic-fees-using-javascript",permalink:"/quickstart/sending-transactions-with-dynamic-fees-using-javascript",draft:!1,editUrl:"https://github.com/luxdefi/network-docs/edit/main/docs/quickstart/sending-transactions-with-dynamic-fees-using-javascript.md",tags:[],version:"current",frontMatter:{description:"This tutorial will help users to send transactions with dynamic fee settings to adjust their priority fee and max fee cap during high network activity using javascript."},sidebar:"quickStart",previous:{title:"Adjusting Gas Price During High Network Activity",permalink:"/quickstart/adjusting-gas-price-during-high-network-activity"},next:{title:"Tools and Utilities",permalink:"/quickstart/tools-list"}},d={},u=[{value:"Overview",id:"overview",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Installing dependencies",id:"installing-dependencies",level:2},{value:"Setting up Environment and Project",id:"setting-up-environment-and-project",level:2},{value:"Importing Dependencies and Private Key",id:"importing-dependencies-and-private-key",level:2},{value:"Setting up HTTP Provider Connected with Fuji Network",id:"setting-up-http-provider-connected-with-fuji-network",level:2},{value:"Setting up C-Chain APIs for Estimating Base and Priority Fees",id:"setting-up-c-chain-apis-for-estimating-base-and-priority-fees",level:2},{value:"Setting up Wallet",id:"setting-up-wallet",level:2},{value:"Function for Estimating Max Fee and Max Priority Fee",id:"function-for-estimating-max-fee-and-max-priority-fee",level:2},{value:"Function to Create, Sign and Send Transaction",id:"function-to-create-sign-and-send-transaction",level:2},{value:"Calling the <code>sendLUX()</code> Function",id:"calling-the-sendlux-function",level:2},{value:"Reissuance of Stuck Transaction",id:"reissuance-of-stuck-transaction",level:2},{value:"Conclusion",id:"conclusion",level:2}],p={toc:u};function h(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"sending-transactions-with-dynamic-fees-using-javascript"},"Sending Transactions with Dynamic Fees using Javascript"),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"The objective of this document is to provide and explain sending transactions with dynamic fees using javascript. Make sure you have followed ",(0,r.kt)("a",{parentName:"p",href:"/quickstart/adjusting-gas-price-during-high-network-activity"},"the tutorial on adjusting the dynamic fees using MetaMask"),". There, we have explained the key concepts related to dynamic fees and EIP1559 type of transactions."),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Basic familiarity with ",(0,r.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript"},"Javascript"),"."),(0,r.kt)("li",{parentName:"ul"},"Basic familiarity with ",(0,r.kt)("a",{parentName:"li",href:"https://nodejs.org/en"},"Node.js")," and ",(0,r.kt)("a",{parentName:"li",href:"https://www.npmjs.com/"},"npm"),"."),(0,r.kt)("li",{parentName:"ul"},"Basic familiarity with ",(0,r.kt)("a",{parentName:"li",href:"/apis/luxd/apis/c-chain"},"the Lux C-Chain")," network and ",(0,r.kt)("a",{parentName:"li",href:"https://ethereum.org/en/developers/docs/evm/"},"EVM compatibility")),(0,r.kt)("li",{parentName:"ul"},"Basic understanding of ",(0,r.kt)("a",{parentName:"li",href:"/quickstart/adjusting-gas-price-during-high-network-activity#good-to-know-keywords-and-concepts"},"dynamic fee transactions")," transactions")),(0,r.kt)("h2",{id:"installing-dependencies"},"Installing dependencies"),(0,r.kt)("p",null,"Open the terminal and install the following dependencies in a new folder."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"ethers"),(0,r.kt)("li",{parentName:"ul"},"lux"),(0,r.kt)("li",{parentName:"ul"},"dotenv")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"npm install ethers lux dotenv\n")),(0,r.kt)("h2",{id:"setting-up-environment-and-project"},"Setting up Environment and Project"),(0,r.kt)("p",null,"To send a transaction we need to sign it using our private key. But private key should not be hardcoded in the code, rather must be fetched through some environment variables. Make a ",(0,r.kt)("inlineCode",{parentName:"p"},".env")," file in the root folder with the following content."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-env"},"PRIVATEKEY=<YOUR_PRIVATE_KEY>\n")),(0,r.kt)("p",null,"Now make a new file ",(0,r.kt)("inlineCode",{parentName:"p"},"app.js")," in the root folder, which will be our main and only file with the ",(0,r.kt)("inlineCode",{parentName:"p"},"sendLux()")," function. Follow the rest of the tutorial by understanding and pasting the provided snippets sequentially in the ",(0,r.kt)("inlineCode",{parentName:"p"},"app.js")," file."),(0,r.kt)("h2",{id:"importing-dependencies-and-private-key"},"Importing Dependencies and Private Key"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'const ethers = require("ethers")\nconst Lux = require("lux").Lux\nrequire("dotenv").config()\n\nconst privateKey = process.env.PRIVATEKEY\n')),(0,r.kt)("h2",{id:"setting-up-http-provider-connected-with-fuji-network"},"Setting up HTTP Provider Connected with Fuji Network"),(0,r.kt)("p",null,"Using the HTTP provider, we will connect to one of the nodes on the Fuji network. Using this provider we will send the signed transaction to the network. You can also connect to mainnet using the URL - ",(0,r.kt)("inlineCode",{parentName:"p"},"https://api.lux.network/ext/bc/C/rpc")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// For sending a signed transaction to the network\nconst nodeURL = "https://api.lux-test.network/ext/bc/C/rpc"\nconst HTTPSProvider = new ethers.providers.JsonRpcProvider(nodeURL)\n')),(0,r.kt)("h2",{id:"setting-up-c-chain-apis-for-estimating-base-and-priority-fees"},"Setting up C-Chain APIs for Estimating Base and Priority Fees"),(0,r.kt)("p",null,"To estimate the max fee and max priority fee on the network, we will be using C-Chain APIs. We can use the C-Chain through an LuxJS instance connected to the network as shown below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// For estimating max fee and priority fee using CChain APIs\nconst chainId = 43113\nconst lux = new Lux(\n  "api.lux-test.network",\n  undefined,\n  "https",\n  chainId\n)\nconst cchain = lux.CChain()\n')),(0,r.kt)("h2",{id:"setting-up-wallet"},"Setting up Wallet"),(0,r.kt)("p",null,"A wallet is required for signing transactions with your private key and thus making it valid."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// For signing an unsigned transaction\nconst wallet = new ethers.Wallet(privateKey)\nconst address = wallet.address\n")),(0,r.kt)("h2",{id:"function-for-estimating-max-fee-and-max-priority-fee"},"Function for Estimating Max Fee and Max Priority Fee"),(0,r.kt)("p",null,"The function ",(0,r.kt)("inlineCode",{parentName:"p"},"calcFeeData()")," estimates the max fee and max priority fee per gas according to network activity using the C-Chain APIs. This function returns max fee and max priority fee per gas in units of ",(0,r.kt)("inlineCode",{parentName:"p"},"nLUX")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"gwei")," (1 LUX = 10^9 gWei)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// Function to estimate max fee and max priority fee\nconst calcFeeData = async (\n  maxFeePerGas = undefined,\n  maxPriorityFeePerGas = undefined\n) => {\n  const baseFee = parseInt(await cchain.getBaseFee(), 16) / 1e9\n  maxPriorityFeePerGas =\n    maxPriorityFeePerGas == undefined\n      ? parseInt(await cchain.getMaxPriorityFeePerGas(), 16) / 1e9\n      : maxPriorityFeePerGas\n  maxFeePerGas =\n    maxFeePerGas == undefined ? baseFee + maxPriorityFeePerGas : maxFeePerGas\n\n  if (maxFeePerGas < maxPriorityFeePerGas) {\n    throw "Error: Max fee per gas cannot be less than max priority fee per gas"\n  }\n\n  return {\n    maxFeePerGas: maxFeePerGas.toString(),\n    maxPriorityFeePerGas: maxPriorityFeePerGas.toString(),\n  }\n}\n')),(0,r.kt)("p",null,"Actual API returns base fee and priority fee in units of ",(0,r.kt)("inlineCode",{parentName:"p"},"wei")," which is one-billionth of a billionth of ",(0,r.kt)("inlineCode",{parentName:"p"},"LUX")," (1 LUX = 10^18 wei)."),(0,r.kt)("h2",{id:"function-to-create-sign-and-send-transaction"},"Function to Create, Sign and Send Transaction"),(0,r.kt)("p",null,"The function ",(0,r.kt)("inlineCode",{parentName:"p"},"sendLux()")," takes 4 arguments -"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"amount")," - Amount of LUX to send in the transaction"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"address")," - Destination address to which we want to send LUX"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"maxFeePerGas")," - Desired maximum fee per gas you want to pay in nLUX"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"maxPriorityFeePerGas")," - Desired maximum priority fee per gas you want to pay in nLUX"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nonce")," - Used as a differentiator for more than 1 transaction with same signer")),(0,r.kt)("p",null,"The last 3 arguments are optional, and if ",(0,r.kt)("inlineCode",{parentName:"p"},"undefined")," is passed, then it will use the ",(0,r.kt)("inlineCode",{parentName:"p"},"calcFeeData()")," function to estimate them. Each transaction with the same data and parameters is differentiated by a nonce value. If there are more than 1 transactions with the same nonce signed by the same address, then only 1 of them with the highest effective priority fee will be accepted. ",(0,r.kt)("inlineCode",{parentName:"p"},"nonce")," parameter should only be used when you are either re-issuing or cancelling a stuck transaction."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// Function to send LUX\nconst sendLux = async (\n  amount,\n  to,\n  maxFeePerGas = undefined,\n  maxPriorityFeePerGas = undefined,\n  nonce = undefined\n) => {\n  if (nonce == undefined) {\n    nonce = await HTTPSProvider.getTransactionCount(address)\n  }\n\n  // If the max fee or max priority fee is not provided, then it will automatically calculate using CChain APIs\n  ;({ maxFeePerGas, maxPriorityFeePerGas } = await calcFeeData(\n    maxFeePerGas,\n    maxPriorityFeePerGas\n  ))\n\n  maxFeePerGas = ethers.utils.parseUnits(maxFeePerGas, "gwei")\n  maxPriorityFeePerGas = ethers.utils.parseUnits(maxPriorityFeePerGas, "gwei")\n\n  // Type 2 transaction is for EIP1559\n  const tx = {\n    type: 2,\n    nonce,\n    to,\n    maxPriorityFeePerGas,\n    maxFeePerGas,\n    value: ethers.utils.parseEther(amount),\n    chainId,\n  }\n\n  tx.gasLimit = await HTTPSProvider.estimateGas(tx)\n\n  const signedTx = await wallet.signTransaction(tx)\n  const txHash = ethers.utils.keccak256(signedTx)\n\n  console.log("Sending signed transaction")\n\n  // Sending a signed transaction and waiting for its inclusion\n  await (await HTTPSProvider.sendTransaction(signedTx)).wait()\n\n  console.log(\n    `View transaction with nonce ${nonce}: https://testnet.snowtrace.io/tx/${txHash}`\n  )\n}\n')),(0,r.kt)("p",null,"This function calculates transaction hash from the signed transaction and logs on the console, the URL for transaction status on the Snowtrace explorer."),(0,r.kt)("h2",{id:"calling-the-sendlux-function"},"Calling the ",(0,r.kt)("inlineCode",{parentName:"h2"},"sendLUX()")," Function"),(0,r.kt)("p",null,"There are various ways to call this function. We may or may not pass the optional arguments like max fee and max priority fee. It is recommended to set the max fee as the maximum price per gas that you are willing to pay for a transaction, no matter how high or low the base fee will be, as at max you will only be charged the provided max fee, along with a small priority fee above the base fee."),(0,r.kt)("p",null,"If you do not pass these arguments, then it will automatically estimate the max fee and priority fee from the network. For example, let's say, I want to pay 100 nLUX per gas for a transaction and a small tip of 2 nLUX, then we will call the following function."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// setting max fee as 100 and priority fee as 2\nsendLux("0.01", "0x856EA4B78947c3A5CD2256F85B2B147fEBDb7124", 100, 2)\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"This function should not be used without a max fee per gas. As you will have to pay the estimated price, even if it is higher than your budget.")),(0,r.kt)("p",null,"There could be the following cases -"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Max Fee"),(0,r.kt)("th",{parentName:"tr",align:null},"Max Priority Fee"),(0,r.kt)("th",{parentName:"tr",align:null},"Comment"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"undefined")),(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"It will calculate the max fee by adding the provided priority fee with the estimated base fee. Take extra precaution here as the max fee will now be capped by ",(0,r.kt)("inlineCode",{parentName:"td"},"baseFee + priorityFee"),", which can consume all the provided priority fees.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"100"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"undefined")),(0,r.kt)("td",{parentName:"tr",align:null},"It will estimate the priority fee and use the provided max fee. If the estimated priority fee is more than the provided max fee, then it throws an error.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"undefined")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"undefined")),(0,r.kt)("td",{parentName:"tr",align:null},"It will estimate the base fee and priority fee from the network, and will add both the values to calculate the max fee per gas. Again, you have to pay whatever will be estimated.")))),(0,r.kt)("p",null,"You will get the following output on the successful submission of the signed transactions. Using this URL you can view the status of your transaction on Snowtrace."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"View transaction with nonce 25: https://testnet.snowtrace.io/tx/0xd5b92b85beaf283fbaeeefb95c9a17a6b346a05b6f9687f2d6e421aa79243b35\n")),(0,r.kt)("h2",{id:"reissuance-of-stuck-transaction"},"Reissuance of Stuck Transaction"),(0,r.kt)("p",null,"Sometimes during high network activity, all transactions couldn't make it to the latest blocks for a long time, due to relatively lower effective tip than the other transactions in the pool. We can either re-issue the same transaction with a higher priority fee or cancel the transaction. To re-issue the stuck transaction, you can send a new one with same amount and data but higher priority fee and same nonce value as the stuck transaction. The transaction with lower effective tip will automatically be rejected (due to same nonce), and you do not need to worry about it. You can also cancel the stuck transaction, by keeping the amount to 0, with a higher priority fee and same nonce. Let's say, the above transaction with a nonce value of 25 has stuck. You can then re-issue a new transaction with same nonce, but higher priority fee this time."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'// reissuing transaction with nonce 25\nsendLux("0.01", "0x856EA4B78947c3A5CD2256F85B2B147fEBDb7124", 100, 10, 25)\n\n// cancelling transaction with nonce 25\nsendLux("0", "0x856EA4B78947c3A5CD2256F85B2B147fEBDb7124", 100, 10, 25)\n')),(0,r.kt)("h2",{id:"conclusion"},"Conclusion"),(0,r.kt)("p",null,"You have learned about creating, signing, and sending transactions with dynamic fee parameters to the C-Chain of Lux network using javascript. It also explained, how to re-issue or cancel a stuck transaction, by sending a transaction with the same nonce. This tutorial points out the recommended way for choosing max fee cap and max priority fee cap for transactions and can also work as a general guide for all the EVM-based chains."))}h.isMDXComponent=!0}}]);